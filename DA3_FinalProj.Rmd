---
title: "Stat 8330 Final Project Report"
author: "Katie Price, Emily Scully, Ben Graves, Ellen Fitzsimmons, and Mira Isnainy"
date: \today
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install.packages("ncdf4")
#install.packages("raster")
#install.packages("rgdal")
#install.packages("ggplot2")
#install.packages("ncdf4.helpers")
#install.packages("PCICt")
library(ncdf4) # package for netcdf manipulation
library(raster) # package for raster manipulation
library(rgdal) # package for geospatial analysis
library(ggplot2) # package for plotting
library(ncdf4.helpers)
library(PCICt)
library(lubridate)
library(dplyr)
library(maps)
library(fields)
library(tidyr)
library(glmnet)
library(randomForest)
library(BART)
library(xtable)
options(xtable.comment = FALSE)
```

## Introduction
Meteorologists study long and hard to predict weather patterns, day in and day out. Anticipating precipitation in North America is not only a convenience for the general public, but a necessity for farmers and agriculturalists. The importance of clean water is a secret to no one. Clean water is not only a key factor in the survival of nearly all living species, but also a key resource for power and production in the modern world. From food production to electricity, water can be used in many different forms for many important aspects of the human experience. Predicting precipitation and subsequently predicting to some extent the frequency and volume of available freshwater is a valuable and essential analysis. This study looks to examine the relationship between sea surface temperatures (henceforth SST) patterns in the tropical Pacific Ocean and precipitation over North America. It was our desire to be able to predict precipitation levels based on SST, both contemporaneously and on a future-time basis. We used several different methods to predict the precipitation outcomes as accurately as possible, including: **insert all methods here**. 

## Exploratory Data Analysis
The data available includes  monthly SST anomalies on a grid for the period January 1948 through February 2018. These "anomalies" consist of differences of the temperature from a long-term average. Additionally, the data includes precipitation data for a majority of the North American continent.

## Methods Considered

```{r data, echo=FALSE}
## import data
# To load the RData
load("data_in_dfs.RData")

```

### Baseline: Climatology


### Baseline: Persistence
- $\tau$ represents number of months before predicted precipitation date


### CNN
- With naive temperature clusters
  - With no lead time
  - With 6-month lead time
  - With Principal Components instead of SST data
  
  
### Random Forest

- For random forest, predicted precip from sst
- Ben should add his stuff about PCA and clust before this because it's based on that
- used kpca clustering for land and sea and got average precip and avg sst for their respective clusters (5 clusters for sst and 12 clusters for precip)
- used average sst in given month-year for each sea cluster as predictors of the precipitation of the same month-year
- training set is time pre 2017 and testing set is 2017 and 2018
- The number of variables randomly sampled as candidates at each split is set to 2

## Results

### Baseline: Climatology

```{r clim_mod, echo=FALSE}
# Climatology Predictions (average of all previous months) ##############

# All months through 2016
Pdat_df_train = Pdat_df[,1:grep(pattern = "Dec2016", x = names(Pdat_df))]

# All months in 2017 only
Pdat_df_test = Pdat_df[, c(grep(pattern = "2017", x = names(Pdat_df)))]
Pdat_df_test = cbind(Pdat_df[,c("long", "lat")], Pdat_df_test)

# Predict using climatology method (average of all previous months)
Pdat_df_preds = data.frame(Pdat_df_train[,c("long", "lat")])
for(i in month.abb) {
  Pdat_df_preds[, paste0(i, "2017pred")] =
    rowMeans(Pdat_df_train[, grep(pattern = i,
                                  x = names(Pdat_df_train))])
}

# MSE from climatology predictions (average of all previous months)
MSE_clim = vector()
for(i in month.abb) {
  MSE_clim[i] = colMeans(((Pdat_df_test[grep(pattern = i,
                                        x = names(Pdat_df_test))] -
                        Pdat_df_preds[, grep(pattern = i,
                                             x = names(Pdat_df_preds))]) ^ 2),
                    na.rm = TRUE)
}

# Plot of the January predictions
Jan2017Pred_raster <- rasterFromXYZ(Pdat_df_preds[, c("long", "lat", "Jan2017pred")])
plot(Jan2017Pred_raster)

# Plot of the January true values
Jan2017True_raster <- rasterFromXYZ(Pdat_df_test[, c("long", "lat", "Jan2017")])
plot(Jan2017True_raster)

```

```{r clim_mod_plot, echo=FALSE}
state_map = map_data("state")
bmap = map_data("state")


# Fancy plots
ggplot() +
  coord_fixed(ratio = 1) +
  geom_raster(data = Pdat_df_preds,
              aes(x = long, y = lat, fill = May2017pred),
              alpha = 1) +
  geom_polygon(
    data = bmap,
    aes(x = long, y = lat, group = group),
    inherit.aes = F,
    colour = 'black',
    fill = NA,
    lwd = 0.5
  ) +
  scale_fill_gradientn(
    na.value = "white",
    # Limits need to be updated accordingly
    limits = c(min(Pdat_df_preds$May2017pred) - 0.5, 
               max(Pdat_df_preds$May2017pred) + 0.5),
    colours = c("blue", "green", "orange", "yellow")
  )+
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black",
                                fill = NA,
                                size = 0.5),
    panel.background = element_blank()
  ) + 
  labs(fill = "Precipication \nUnits", 
       title = "May 2017 Predicted Precipitation")

```

### Baseline: Persistence

- test MSE increases as tau approaches 6 month intervals away from the predicted date and decreases as tau approaches 12 month intervals away from the predicted date
- Basically MSE is lower when using data from the same time of year as the predicted date

```{r pers_mod, echo=FALSE, message=FALSE}
# Persistence Predictions (pred_(t + tau) = pred_t) ##############


# Need to define how far out we want tau to be
# Project document suggests 6 months?

## I based this on the following tutorial:
# https://machinelearningmastery.com/persistence-time-series-forecasting-with-python/


## Step 1
## transform univariate dataset into supervised learning problem
## load the data set and create a lagged representation
## i.e. given the observation at t predict the observation at t + tau
predprecip <- function(df, tau){
  ## df is dataframe
  ## tau is distance from prediction point
  mat <- as.matrix(df)
  predprecip <- matrix(NA, nrow = nrow(mat), ncol = ncol(mat) + tau)
  colnames(predprecip) <- c(colnames(mat), c(paste("x", 1:tau, sep = "")))
  for(i in 1:ncol(mat)){
    if(i < 3){
      predprecip[, i] <- mat[, i]
    } else{
      ttau <- i + tau
      predprecip[, ttau] <- mat[, i]
    }
  }
  preddf <- as.data.frame(predprecip)
  return(preddf)
}

## predicted precipitations when tau = 6 months
preddf <- predprecip(Pdat_df, 6)

## Step 2
## establish train and test datasets for test harness
## This isn't necessary, but if we want to add it we can

## Step 3
## Define persistence model
## This step is also unnecessary because we can extract it from step 1

## Step 4
## Make forecast and establish baseline performance
testmse <- function(Pdat_df, preddf){
  longdatorig <- gather(Pdat_df, time, precip, 3:ncol(Pdat_df))
  longdatpred <- gather(preddf, time, precip, 3:ncol(preddf))
  
  y <- data.frame("ytest" = longdatorig$precip, "yhat" = longdatpred[1:nrow(longdatorig), ]$precip)
  y <- na.omit(y)
  testmse <- mean((y$yhat - y$ytest)^2)
  return(testmse)
}

```

```{r pers_mod_plot, echo=FALSE, cache=TRUE}
## It seems MSE increases as tau approaches the 6 months mark and decreases 
## as it approaches the 12 month mark
n <- 24
msemat <- matrix(c(1:n, rep(NA, n)), nrow = n, ncol = 2, byrow = FALSE)
colnames(msemat) <- c("tau", "mse")
for(i in 1:n){
  preddf <- predprecip(Pdat_df, i)
  msemat[i, 2] <- testmse(Pdat_df, preddf)
}

ggplot(data=as.data.frame(msemat), aes(x=tau, y=mse, group=1)) +
  geom_line()+
  geom_point() +
  xlab("tau: Number of Months Ahead of Prediction") +
  ylab("Test MSE") +
  labs(title = "Test MSE for Varying Values of tau")

```

```{r pers_mod_mse, echo=FALSE, cache=TRUE}
## MSE when tau = 12
tau <- 12
preddf <- predprecip(Pdat_df, tau)
testmsepers <- testmse(Pdat_df, preddf)

```

### CNN

### Random Forest

```{r rf1, echo=FALSE, cache=TRUE}
# load 
load("SST_clustwide.RData")
load("Pdat_clustwide.RData")
load("SST_longagg.RData")
load("Pdat_longagg.RData")

## row 829 is beginning of 2017
train <- c(1:828)

all_train <- data.frame(Pdat_clustwide[train,], SST_clustwide[train,])
all_long_train <- gather(all_train, landclus, landclusavg, 2:13)
all_long_train <- all_long_train[-2]
all_test <- data.frame(Pdat_clustwide[-train,], SST_clustwide[-train,])
all_long_test <- gather(all_test, landclus, landclusavg, 2:13)
all_long_test <- all_long_test[-2]

## using sst and precip
set.seed(125498)
m <- round(sqrt(ncol(all_long_train) - 2), 0)
rf.sst <- randomForest(landclusavg ~ SeaCluster1 + SeaCluster2 + SeaCluster3 + SeaCluster4 + SeaCluster5,
                       data = all_long_train,
                       mtry = m,
                       importance = TRUE)

```

```{r rf2, echo=FALSE, cache=TRUE}
# rf.sst$importance

yhat.rf <- predict(rf.sst, newdata = as.matrix(all_long_test[,c(-1, -7)]))

testmserfcont <- mean((yhat.rf - all_long_test[, 8]))

# plot(yhat.rf, all_long_test[, 8])
# abline(0,1)

```


```{r echo=FALSE, results='asis'}
df <- data.frame("Model" = c("Baseline: Climatology January", 
                             "Baseline: Climatology February",
                             "Baseline: Climatology March",
                             "Baseline: Climatology April",
                             "Baseline: Climatology May",
                             "Baseline: Climatology June",
                             "Baseline: Climatology July",
                             "Baseline: Climatology August",
                             "Baseline: Climatology September",
                             "Baseline: Climatology October", 
                             "Baseline: Climatology November",
                             "Baseline: Climatology December",
                             "Baseline: Persistence", 
                              "Random Forest"),
                    "Test MSE" = c(MSE_clim, testmsepers, testmserfcont))

print(xtable(df, caption = "Test MSE Values"), include.rownames = FALSE)
```

## Conclusion